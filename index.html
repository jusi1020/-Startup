<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìº í¼ìŠ¤ ê°€ì´ë“œ | êµí†µÂ·ì‹ë‹¨</title>
  <meta name="build" content="2025-10-12 merged-bus-rail+excel" />
  <style>
    :root {
      --bg:#0b0b0c; --card:#151518; --muted:#979aa1; --text:#e9e9ee; --border:#23232a;
      --accent:#34406a; --accentBg:#21263b; --railBg:#1e4a32; --busBg:#1e3a5f;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,sans-serif;color:var(--text);background:radial-gradient(1000px 500px at 10% -20%,#182033 0%,#0d101a 40%,var(--bg) 80%);}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    header h1{font-size:28px;margin:0 0 4px}
    .card{background:linear-gradient(180deg,#171922,#12131a);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden;margin-top:20px}
    .toolbar{display:flex;gap:10px;padding:14px;border-bottom:1px solid var(--border);align-items:center;background:rgba(255,255,255,.02);flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#191a21;color:#e9e9ee;font-weight:600;padding:10px 14px;border-radius:10px;cursor:pointer;transition:transform .06s,border-color .2s,background .2s;white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{transform:translateY(-1px)} .btn.active{color:#fff;border-color:var(--accent);background:var(--accentBg)}
    .submenu,.controls{display:flex;gap:8px;padding:12px 14px;border-bottom:1px dashed var(--border);align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:6px;padding:12px 14px;border-bottom:1px dashed var(--border)}
    .tab{border:1px solid var(--border);background:#14151b;color:#979aa1;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .tab.active{color:#fff;border-color:var(--accent);background:var(--accentBg)}
    .content{padding:16px}
    .title-row{display:flex;gap:10px;align-items:baseline;margin-bottom:8px;flex-wrap:wrap}
    .title-row h2{margin:0;font-size:20px;font-weight:700}
    .title-row .meta{font-size:12px;color:#979aa1}
    table{width:100%;border-collapse:collapse;border-radius:12px;border:1px solid var(--border);background:#0f1118;overflow:hidden}
    thead th{background:#171a24;color:#d6d8de;text-align:left;padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border)}
    tbody td{border-top:1px solid var(--border);padding:9px 12px;font-size:14px;color:#e9eaf0}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    tbody tr.hour-sep td{border-top:2px solid var(--accent);opacity:.35;padding:2px;font-size:11px;text-align:center;background:rgba(52,64,106,0.1)}
    .type{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;font-weight:700;margin-right:6px}
    .type.bus{background:var(--busBg);color:#a3c3ff}
    .type.rail{background:var(--railBg);color:#a3ffcc}
    tr.next{background:rgba(66,103,178,.18)}
    .toggle{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--border);background:#14151b;border-radius:10px;padding:6px 10px;margin-left:auto}
    .toggle input{margin:0}
    .empty{padding:24px;text-align:center;color:#979aa1}
    footer{margin-top:28px;color:#979aa1;font-size:12px}
    select, .chip {background:#14151b;border:1px solid var(--border);color:#e9e9ee;border-radius:8px;padding:6px 8px}
    .chip {cursor:pointer;user-select:none}
    .chip.active{border-color:var(--accent);background:var(--accentBg)}
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>ìº í¼ìŠ¤ ê°€ì´ë“œ | êµí†µÂ·ì‹ë‹¨</h1></header>

    <section class="card">
      <!-- ìƒë‹¨: êµí†µ/ì‹ë‹¨ -->
      <div class="toolbar">
        <button id="btnTransport" class="btn active">ğŸšŒ êµí†µ</button>
        <button id="btnMeal" class="btn">ğŸ½ï¸ ì‹ë‹¨</button>

        <div class="toggle" title="í‘œì‹œ ì„¤ì •">
          <label><input id="chkBus" type="checkbox" checked /> ë²„ìŠ¤</label>
          <label><input id="chkRail" type="checkbox" /> ì² ë„</label>
          <select id="railMode">
            <option value="intercity" selected>ì¼ë°˜ì² ë„</option>
            <option value="subway">ë„ì‹œì² ë„</option>
          </select>
        </div>
      </div>

      <!-- êµí†µ: ë°©í–¥ & ìš”ì¼ -->
      <div id="barTransport" class="submenu">
        <button id="btnToSchool" class="btn active">í•™êµë¡œ <span style="opacity:.7">(ë°€ì–‘â†’ë¶€ì‚°ëŒ€)</span></button>
        <button id="btnToStation" class="btn">ì—­ìœ¼ë¡œ <span style="opacity:.7">(ë¶€ì‚°ëŒ€â†’ë°€ì–‘)</span></button>
      </div>
      <div id="tabsDay" class="tabs">
        <button class="tab active" data-day="í‰ì¼">í‰ì¼</button>
        <button class="tab" data-day="ì£¼ë§Â·ê³µíœ´ì¼">ì£¼ë§Â·ê³µíœ´ì¼</button>
        <button class="tab" data-day="ë°©í•™">ë°©í•™</button>
      </div>

      <!-- ì² ë„ ëª©ì ì§€ ì„ íƒ -->
      <div id="barRailDest" class="controls" style="display:none">
        <span style="opacity:.8">ì² ë„ ëª©ì ì§€</span>
        <div id="railDestChips" class="chips" style="display:flex;gap:6px;flex-wrap:wrap"></div>

        <!-- ë„ì‹œì² ë„(ì—‘ì…€ â†’ ì…€ë ‰íŠ¸) -->
        <div id="subwayCfg" style="display:none;gap:6px;align-items:center">
          <span style="opacity:.6">ë„ì‹œì² ë„ ì½”ë“œ</span>
          <div id="subwayFields" style="display:flex;gap:6px;align-items:center"></div>
          <button id="btnSubwaySave" class="btn">ì €ì¥</button>
          <small id="railHint" style="color:#9cc7da"></small>
        </div>
      </div>

      <!-- ì‹ë‹¨: ìˆì„ ë•Œë§Œ ì‚¬ìš© -->
      <div id="barMeal" class="submenu" style="display:none">
        <button id="btnDorm" class="btn">ê¸°ìˆ™ì‚¬</button>
        <button id="btnUnion" class="btn">í•™ìƒíšŒê´€</button>
        <div class="controls">
          <label>ë‚ ì§œ <input id="mealDate" type="date" /></label>
        </div>
      </div>

      <div id="content" class="content"><div class="empty">ìƒë‹¨ì—ì„œ ë°©í–¥ê³¼ ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div></div>
    </section>

    <footer>ë°ì´í„°: <code>bus_schedule.json</code>, <code>menu.json</code>, <code>KRIC(ë„ì‹œì² ë„)</code>, <code>êµ­ê°€ì² ë„(ì¼ë°˜ì² ë„)</code></footer>
  </div>

  <!-- ì—‘ì…€ íŒŒì‹±ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  // ---------------- App State ----------------
  const STATE = {
    mode: 'transport',
    direction: 'toSchool',       // 'toSchool' | 'toStation'
    dayType: 'í‰ì¼',             // 'í‰ì¼' | 'ì£¼ë§Â·ê³µíœ´ì¼' | 'ë°©í•™'
    showBus: true,
    showRail: false,
    railMode: 'intercity',       // 'intercity' | 'subway'
    railDest: null,              // intercity ëª©ì ì§€(í‘œì‹œìš©)
    busLoaded: false,
    bus: { toSchool: [], toStation: [] },    // bus_schedule.json
    mealsLoaded: false,
    meals: {},                                // menu.json (ì˜µì…˜)
    subwayCfg: { railOprIsttCd:'', lnCd:'', stinCd:'' },
    railCache: {}                              // key = `${railMode}|${direction}|${dayType}|${railDest||''}`
  };

  const DESTS = ["ë¶€ì‚°","êµ¬í¬","ë™ëŒ€êµ¬","ëŒ€ì „","ì„œìš¸"]; // intercity ëª©ì ì§€

  // ---------------- Utilities ----------------
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const pad = n=>String(n).padStart(2,'0');
  function fmtTime(v){
    if(!v) return "";
    let s=String(v).trim();
    let m = s.match(/^(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{1,2})/);
    if(m){ let h=+m[2], mi=pad(m[3]); const pm=m[1]==='ì˜¤í›„'; if(pm && h!==12) h+=12; if(!pm && h===12) h=0; return pad(h)+':'+mi; }
    m = s.match(/^(\d{1,2}):(\d{2})/); if(m) return pad(m[1])+':'+m[2];
    return s;
  }
  const toMinutes = hhmm => { const m = fmtTime(hhmm).match(/^(\d{2}):(\d{2})$/); return m ? (+m[1]*60 + +m[2]) : NaN; };
  const nowMinutes = () => new Date().getHours()*60 + new Date().getMinutes();
  function showEmpty(text='ë°ì´í„° ì—†ìŒ'){ const d=document.createElement('div'); d.className='empty'; d.textContent=text; return d; }

  // ---------------- Loaders ----------------
  async function ensureBusLoaded(){
    if(STATE.busLoaded) return;
    const r = await fetch('./bus_schedule.json', { cache:'no-store' });
    if(!r.ok){ $('#content').innerHTML=''; $('#content').appendChild(showEmpty('ë²„ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨')); return; }
    STATE.bus = await r.json();
    STATE.busLoaded = true;
  }
  async function ensureMealsLoaded(){
    if(STATE.mealsLoaded) return;
    const r = await fetch('./menu.json', { cache:'no-store' });
    if(!r.ok) return;
    STATE.meals = await r.json();
    STATE.mealsLoaded = true;
  }

  function dayToKRIC(dayType){ if(dayType==='í‰ì¼') return ['8']; if(dayType==='ì£¼ë§Â·ê³µíœ´ì¼') return ['7','9']; return ['8']; }

  // ----- ì¼ë°˜ì² ë„(êµ­ê°€ì² ë„) -----
  async function loadIntercity(direction, dayType, dest){
    const key = `intercity|${direction}|${dayType}|${dest||''}`;
    if(STATE.railCache[key]) return STATE.railCache[key];
    if(!dest) return [];

    const from = direction==='toStation' ? 'ë°€ì–‘' : dest;
    const to   = direction==='toStation' ? dest  : 'ë°€ì–‘';
    const d = new Date(); const ymd = d.getFullYear()+String(d.getMonth()+1).padStart(2,"0")+String(d.getDate()).padStart(2,"0");

    const url = new URL('/api/korailTimetable', location.origin);
    url.searchParams.set('from', from);
    url.searchParams.set('to', to);
    url.searchParams.set('date', ymd);

    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok){ return []; }
    const j = await r.json();
    const items = j?.response?.body?.items?.item ?? j?.items ?? j?.trains ?? [];
    const rows = [];
    for(const it of items){
      const raw = String(it.depPlandTime || it.dptTm || it.depTime || '').slice(-4); // HHmm
      if(!raw) continue;
      const hhmm = raw.replace(/(\d{2})(\d{2})/,'$1:$2');
      const min  = toMinutes(hhmm);
      if(isNaN(min)) continue;
      rows.push({ type:'rail', time:hhmm, timeMin:min, trnNo:it.trainNo || it.trnNo || '', dest:`${from}â†’${to}` });
    }
    rows.sort((a,b)=>a.timeMin-b.timeMin);
    STATE.railCache[key] = rows;
    return rows;
  }

  // ----- ë„ì‹œì² ë„(KRIC) -----
  async function loadSubway(direction, dayType){
    const key = `subway|${direction}|${dayType}`;
    if(STATE.railCache[key]) return STATE.railCache[key];

    const { railOprIsttCd, lnCd, stinCd } = STATE.subwayCfg;
    if(!railOprIsttCd || !lnCd || !stinCd) return [];

    let rows = [];
    for(const d of dayToKRIC(dayType)){
      const u = new URL('/api/subwayTimetable', location.origin);
      u.searchParams.set('railOprIsttCd', railOprIsttCd);
      u.searchParams.set('lnCd', lnCd);
      u.searchParams.set('stinCd', stinCd);
      u.searchParams.set('dayCd', d);
      u.searchParams.set('format','json');

      const r = await fetch(u, { cache:'no-store' });
      if(!r.ok) continue;
      const j = await r.json();
      const items = j?.response?.body?.items?.item ?? j?.items ?? [];
      for(const it of items){
        const hhmm = (String(it.dptTm||it.arvTm||'').padStart(4,'0')).replace(/(\d{2})(\d{2})/,'$1:$2');
        const min  = toMinutes(hhmm);
        if(isNaN(min)) continue;
        rows.push({ type:'rail', time:hhmm, timeMin:min, trnNo:it.trnNo || '', dest:'ë„ì‹œì² ë„' });
      }
    }
    rows.sort((a,b)=>a.timeMin-b.timeMin);
    STATE.railCache[key] = rows;
    return rows;
  }

  // ----- ì—‘ì…€ â†’ ì…€ë ‰íŠ¸ ìë™ êµ¬ì„± (ë„ì‹œì² ë„) -----
  async function tryEnableSubwaySelectorsFromExcel(){
    const container = $('#subwayFields');
    const hint = $('#railHint');
    container.innerHTML = '';

    try{
      const rx = await fetch('./ìš´ì˜ê¸°ê´€_ì—­ì‚¬_ì½”ë“œì •ë³´_2025.07.04.xls', { cache:'no-store' });
      if(!rx.ok) throw new Error('ì—‘ì…€ íŒŒì¼ì´ ì—†ìŒ');
      const buf = await rx.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header:1 });

      if(rows.length < 2) throw new Error('ì—‘ì…€ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');

      // í—¤ë” ì¸ë±ìŠ¤ ì¶”ë¡ (ê³µì‹ ì—‘ì…€ì˜ ì»¬ëŸ¼ëª…ì´ ì¡°ê¸ˆì”© ë‹¬ë¼ë„ ë§¤ì¹­ë˜ê²Œ)
      const hdr = rows[0].map(h => String(h||'').trim());
      const idx = {
        opr:      hdr.findIndex(h => /ìš´ì˜ê¸°ê´€|ê¸°ê´€.*ì½”ë“œ|railOprIsttCd/i.test(h)),
        oprName:  hdr.findIndex(h => /ìš´ì˜ê¸°ê´€.*(ëª…|ì´ë¦„)|ê¸°ê´€ëª…/i.test(h)),
        line:     hdr.findIndex(h => /(ë…¸ì„ |í˜¸ì„ |ì„ ).*ì½”ë“œ|lnCd/i.test(h)),
        lineName: hdr.findIndex(h => /(ë…¸ì„ |í˜¸ì„ |ì„ ).*(ëª…|ì´ë¦„)/i.test(h)),
        st:       hdr.findIndex(h => /ì—­.*ì½”ë“œ|stinCd/i.test(h)),
        stName:   hdr.findIndex(h => /ì—­.*(ëª…|ì´ë¦„)/i.test(h)),
      };
      if(idx.opr<0||idx.line<0||idx.st<0) throw new Error('í•„ìˆ˜ ì»¬ëŸ¼(ê¸°ê´€/ì„ /ì—­ ì½”ë“œ)ì„ ì°¾ì§€ ëª»í•¨');

      // ê³„ì¸µí™”: operator -> line -> stations[]
      const byOpr = {};
      for(const r of rows.slice(1)){
        const opr = String(r[idx.opr] ?? '').trim(); if(!opr) continue;
        const line = String(r[idx.line] ?? '').trim(); if(!line) continue;
        const st = String(r[idx.st] ?? '').trim(); if(!st) continue;

        const oprName = String(r[idx.oprName] ?? '').trim();
        const lineName = String(r[idx.lineName] ?? '').trim();
        const stName = String(r[idx.stName] ?? '').trim();

        byOpr[opr] ??= { id:opr, name: oprName || opr, lines:{} };
        byOpr[opr].lines[line] ??= { id:line, name: lineName || line, stations:[] };
        byOpr[opr].lines[line].stations.push({ id:st, name: stName || st });
      }
      const operators = Object.values(byOpr).map(op => ({ id:op.id, name:op.name, lines:Object.values(op.lines) }));
      if(operators.length===0) throw new Error('ì—‘ì…€ì—ì„œ ìœ íš¨í•œ ì½”ë“œê°€ ì—†ìŒ');

      // ì…€ë ‰íŠ¸ ìƒì„±
      const selO = document.createElement('select');
      const selL = document.createElement('select');
      const selS = document.createElement('select');
      selO.id='selOpr'; selL.id='selLine'; selS.id='selStation';
      container.appendChild(selO); container.appendChild(selL); container.appendChild(selS);

      function fillLines(){
        const op = operators.find(o => o.id === selO.value);
        selL.innerHTML = (op?.lines||[]).map(li => `<option value="${li.id}">${li.name}(${li.id})</option>`).join('');
        fillStations();
      }
      function fillStations(){
        const op = operators.find(o => o.id === selO.value);
        const li = op?.lines?.find(l => l.id === selL.value);
        selS.innerHTML = (li?.stations||[]).map(s => `<option value="${s.id}">${s.name}(${s.id})</option>`).join('');
      }

      selO.innerHTML = operators.map(op => `<option value="${op.id}">${op.name}(${op.id})</option>`).join('');
      // ë¶€ì‚°êµí†µê³µì‚¬(B1) ê¸°ë³¸ ì„ íƒ ì‹œë„ â†’ ì—†ìœ¼ë©´ ì²« í•­ëª©
      selO.value = operators.some(o=>o.id==='B1') ? 'B1' : operators[0].id;
      fillLines();

      // ë³€ê²½ ì—°ë™
      selO.addEventListener('change', ()=>{ fillLines(); });
      selL.addEventListener('change', ()=>{ fillStations(); });

      // ì €ì¥ ë²„íŠ¼ì´ ì„ íƒê°’ì„ STATEì— ë°˜ì˜
      $('#btnSubwaySave').onclick = ()=>{
        STATE.subwayCfg.railOprIsttCd = selO.value;
        STATE.subwayCfg.lnCd = selL.value;
        STATE.subwayCfg.stinCd = selS.value;
        STATE.railCache = {};
        renderTransport();
      };

      hint.textContent = 'ê³µì‹ ì—‘ì…€ì—ì„œ ìš´ì˜ê¸°ê´€/ë…¸ì„ /ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
    }catch(e){
      // ì—‘ì…€ì„ ì°¾ì§€ ëª»í•˜ë©´ í…ìŠ¤íŠ¸ ì…ë ¥ fallback
      const hint = $('#railHint');
      const fields = $('#subwayFields');
      fields.innerHTML = `
        <input id="inpOpr" placeholder="ìš´ì˜ê¸°ê´€(B1 ë“±)" class="chip" />
        <input id="inpLine" placeholder="ì„ (1 ë“±)" class="chip" />
        <input id="inpStation" placeholder="ì—­ì½”ë“œ(109 ë“±)" class="chip" />
      `;
      $('#btnSubwaySave').onclick = ()=>{
        STATE.subwayCfg.railOprIsttCd = $('#inpOpr').value.trim();
        STATE.subwayCfg.lnCd = $('#inpLine').value.trim();
        STATE.subwayCfg.stinCd = $('#inpStation').value.trim();
        STATE.railCache = {};
        renderTransport();
      };
      hint.textContent = 'ì—‘ì…€ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ì°½ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.';
      console.warn('Subway Excel load failed:', e);
    }
  }

  // ---------------- Renderer (í†µí•©) ----------------
  async function renderTransport(){
    await ensureBusLoaded();

    // ì² ë„ ë°” í‘œì‹œ/êµ¬ì„±
    const bar = $('#barRailDest');
    const chips = $('#railDestChips');
    bar.style.display = STATE.showRail ? '' : 'none';

    if(STATE.showRail && STATE.railMode==='intercity'){
      $('#subwayCfg').style.display='none';
      chips.innerHTML = '';
      const labels = ["ë¶€ì‚°","êµ¬í¬","ë™ëŒ€êµ¬","ëŒ€ì „","ì„œìš¸"].map(x => (STATE.direction==='toStation' ? `ë°€ì–‘â†’${x}` : `${x}â†’ë°€ì–‘`));
      labels.forEach(label=>{
        const div = document.createElement('div');
        div.className = 'chip' + (STATE.railDest===label?' active':'');
        div.textContent = label;
        div.addEventListener('click', ()=>{ STATE.railDest = label; $$('#railDestChips .chip').forEach(c=>c.classList.remove('active')); div.classList.add('active'); renderTransport(); });
        chips.appendChild(div);
      });
      if(!STATE.railDest){ STATE.railDest = labels[0]; }
    }else if(STATE.showRail && STATE.railMode==='subway'){
      chips.innerHTML = '';
      $('#subwayCfg').style.display='';
      // ì—‘ì…€ â†’ ì…€ë ‰íŠ¸ í™œì„±í™”(í•œ ë²ˆë§Œ)
      if(!$('#selOpr') && !$('#inpOpr')) await tryEnableSubwaySelectorsFromExcel();
    }

    const content = $('#content'); content.innerHTML = '';

    // Title
    const title = document.createElement('div'); title.className='title-row';
    const h2 = document.createElement('h2');
    h2.textContent = (STATE.direction==='toSchool' ? 'ë°€ì–‘ â†’ ë¶€ì‚°ëŒ€' : 'ë¶€ì‚°ëŒ€ â†’ ë°€ì–‘');
    const meta = document.createElement('span'); meta.className='meta';
    meta.textContent = STATE.dayType + (STATE.showRail ? ` Â· ì² ë„(${STATE.railMode==='intercity' ? (STATE.railDest||'ì„ íƒ') : 'ë„ì‹œì² ë„'})` : '');
    title.appendChild(h2); title.appendChild(meta); content.appendChild(title);

    // 1) ë²„ìŠ¤ rows
    const src = (STATE.bus[STATE.direction]||[]).filter(d=>d.day_type===STATE.dayType);
    const busRows = STATE.showBus ? src.map(r=>{
      const t = r.t||{};
      const time = STATE.direction==='toSchool' ? (t['ë°€ì–‘ì—­'] || t['ì‹œê°„']) : (t['ë¶€ì‚°ëŒ€'] || t['ì‹œê°„']);
      const timeMin = toMinutes(time);
      if (isNaN(timeMin)) return null;
      return { type:'bus', time:fmtTime(time), timeMin, run:r.run, t };
    }).filter(Boolean) : [];

    // 2) ì² ë„ rows
    let railRows = [];
    if(STATE.showRail){
      if(STATE.railMode==='intercity'){
        const dest = (STATE.railDest||'').replace(/^ë°€ì–‘â†’|â†’ë°€ì–‘/g,'');
        railRows = await loadIntercity(STATE.direction, STATE.dayType, dest);
      }else{
        railRows = await loadSubway(STATE.direction, STATE.dayType);
      }
    }

    // 3) í•©ì¹˜ê¸°
    const rows = [...busRows, ...railRows].sort((a,b)=>a.timeMin-b.timeMin);

    // 4) í‘œ
    const table = document.createElement('table');
    const thead = document.createElement('thead'); const trh=document.createElement('tr');
    const cols = STATE.direction==='toSchool'
      ? ['êµ¬ë¶„','ì‹œê°„','ì˜ë‚¨ë£¨','ë°€ì–‘ì—­','ë¶€ì‚°ëŒ€']
      : ['êµ¬ë¶„','ì‹œê°„','ë¶€ì‚°ëŒ€','ë°€ì–‘ì—­','ì˜ë‚¨ë£¨'];
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
    thead.appendChild(trh); table.appendChild(thead);
    const tbody = document.createElement('tbody');

    if(rows.length===0){ content.appendChild(showEmpty('í•´ë‹¹ ì¡°ê±´ì˜ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.')); return; }

    const nowMin = nowMinutes(); let nextMarked=false; let lastHour=-1;
    for(const item of rows){
      const hour = Math.floor(item.timeMin/60);
      if(hour!==lastHour){
        const sep=document.createElement('tr'); sep.className='hour-sep';
        const td=document.createElement('td'); td.colSpan=cols.length; td.textContent=`â”â”â” ${hour}ì‹œ â”â”â”`;
        sep.appendChild(td); tbody.appendChild(sep); lastHour=hour;
      }

      const tr=document.createElement('tr');
      if(!nextMarked && item.timeMin>=nowMin){ tr.classList.add('next'); nextMarked=true; }

      if(item.type==='bus'){
        const badge = `<span class="type bus">ë²„ìŠ¤</span>`;
        if(STATE.direction==='toSchool'){
          tr.innerHTML = `
            <td>${badge}${item.run?`${item.run}íšŒ`:''}</td>
            <td>${fmtTime(item.t['ì‹œê°„']||'')}</td>
            <td>${fmtTime(item.t['ì˜ë‚¨ë£¨']||'')}</td>
            <td>${fmtTime(item.t['ë°€ì–‘ì—­']||'')}</td>
            <td>${fmtTime(item.t['ë¶€ì‚°ëŒ€']||'')}</td>`;
        }else{
          tr.innerHTML = `
            <td>${badge}${item.run?`${item.run}íšŒ`:''}</td>
            <td>${fmtTime(item.t['ì‹œê°„']||item.t['ë¶€ì‚°ëŒ€']||'')}</td>
            <td>${fmtTime(item.t['ë¶€ì‚°ëŒ€']||'')}</td>
            <td>${fmtTime(item.t['ë°€ì–‘ì—­']||'')}</td>
            <td>${fmtTime(item.t['ì˜ë‚¨ë£¨']||'')}</td>`;
        }
      }else{ // rail (ë„ì‹œ/ì¼ë°˜ ê³µí†µ ë Œë”)
        const badge = `<span class="type rail">ì² ë„</span>`;
        if(STATE.direction==='toSchool'){
          tr.innerHTML = `
            <td>${badge}${item.trnNo||''}</td>
            <td>${item.time}</td>
            <td>-</td>
            <td>${item.dest || 'ì—­'}</td>
            <td>-</td>`;
        }else{
          tr.innerHTML = `
            <td>${badge}${item.trnNo||''}</td>
            <td>${item.time}</td>
            <td>-</td>
            <td>${item.dest || 'ì—­'}</td>
            <td>-</td>`;
        }
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    content.appendChild(table);
  }

  // ---------------- Meals ----------------
  async function renderMeals(hall){
    await ensureMealsLoaded();
    const content = $('#content'); content.innerHTML='';
    const date = $('#mealDate').value || new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
    const d = STATE.meals[hall]?.[date];
    const title = document.createElement('div'); title.className='title-row';
    title.innerHTML = `<h2>ğŸ½ï¸ ${hall}</h2><span class="meta">${date}</span>`;
    content.appendChild(title);
    if(!d){ content.appendChild(showEmpty()); return; }
    for(const sec of ['ì•„ì¹¨','ì ì‹¬','ì €ë…']){
      const h3=document.createElement('h3'); h3.textContent=sec; content.appendChild(h3);
      const ul=document.createElement('ul'); (d[sec]||[]).forEach(x=>{const li=document.createElement('li'); li.textContent=x; ul.appendChild(li);});
      content.appendChild(ul);
    }
  }

  // ---------------- Wire UI ----------------
  function setActive(el, groupSel){ $$(groupSel).forEach(b=>b.classList.remove('active')); el.classList.add('active'); }

  function init(){
    // ìƒë‹¨ ëª¨ë“œ
    $('#btnTransport').addEventListener('click', ()=>{
      STATE.mode='transport';
      $('#btnTransport').classList.add('active'); $('#btnMeal').classList.remove('active');
      $('#barTransport').style.display=''; $('#tabsDay').style.display='';
      $('#barMeal').style.display='none';
      renderTransport();
    });
    $('#btnMeal').addEventListener('click', ()=>{
      STATE.mode='meal';
      $('#btnMeal').classList.add('active'); $('#btnTransport').classList.remove('active');
      $('#barTransport').style.display='none'; $('#tabsDay').style.display='none';
      $('#barMeal').style.display='';
      $('#content').innerHTML='';
      renderMeals('ê¸°ìˆ™ì‚¬');
    });

    // ë°©í–¥
    $('#btnToSchool').addEventListener('click', (e)=>{ STATE.direction='toSchool'; setActive(e.currentTarget,'.submenu .btn'); STATE.railDest=null; renderTransport(); });
    $('#btnToStation').addEventListener('click', (e)=>{ STATE.direction='toStation'; setActive(e.currentTarget,'.submenu .btn'); STATE.railDest=null; renderTransport(); });

    // ìš”ì¼
    $$('#tabsDay .tab').forEach(b=>{
      b.addEventListener('click', (e)=>{
        setActive(e.currentTarget,'#tabsDay .tab'); STATE.dayType = e.currentTarget.dataset.day; renderTransport();
      });
    });

    // í† ê¸€/ëª¨ë“œ
    $('#chkBus').addEventListener('change', (e)=>{ STATE.showBus=e.target.checked; renderTransport(); });
    $('#chkRail').addEventListener('change', (e)=>{ STATE.showRail=e.target.checked; renderTransport(); });
    $('#railMode').addEventListener('change', async (e)=>{ STATE.railMode=e.target.value; STATE.railDest=null; renderTransport(); });

    // ì´ˆê¸° ë Œë”
    renderTransport();
  }
  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
