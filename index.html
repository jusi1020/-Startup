<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìº í¼ìŠ¤ ê°€ì´ë“œ | êµí†µÂ·ì‹ë‹¨</title>
  <meta name="build" content="2025-10-12T00:00+09:00-merged-timetable" />
  <style>
    :root { --bg:#0b0b0c; --card:#151518; --muted:#979aa1; --text:#e9e9ee; --border:#23232a; --accent:#34406a; --accentBg:#21263b; --highlight:#22427a; --highlightOutline:#4267b2; --railBg:#1e4a32; --busBg:#1e3a5f; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,sans-serif;color:var(--text);background:radial-gradient(1000px 500px at 10% -20%,#182033 0%,#0d101a 40%,var(--bg) 80%);}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    header h1{font-size:28px;margin:0 0 4px}
    .card{background:linear-gradient(180deg,#171922,#12131a);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden;margin-top:20px}
    .toolbar{display:flex;gap:10px;padding:14px;border-bottom:1px solid var(--border);align-items:center;background:rgba(255,255,255,.02);flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#191a21;color:#e9e9ee;font-weight:600;padding:10px 14px;border-radius:10px;cursor:pointer;transition:transform .06s,border-color .2s,background .2s;white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.active{color:#fff;border-color:var(--accent);background:var(--accentBg)}
    .btn.ghost{background:transparent}
    .status{display:none;border:1px solid #203847;background:#14222b;color:#9cc7da;padding:4px 8px;border-radius:999px;font-size:12px}
    .submenu{display:none;gap:8px;padding:12px 14px;border-bottom:1px dashed var(--border);align-items:center;flex-wrap:wrap}
    .submenu.open{display:flex}
    .tabs{display:none;gap:6px;padding:12px 14px;border-bottom:1px dashed var(--border)}
    .tab{border:1px solid var(--border);background:#14151b;color:#979aa1;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .tab.active{color:#fff;border-color:var(--accent);background:var(--accentBg)}
    .controls{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px dashed var(--border);flex-wrap:wrap}
    .content{padding:16px}
    .title-row{display:flex;gap:10px;align-items:baseline;margin-bottom:8px;flex-wrap:wrap}
    .title-row h2{margin:0;font-size:20px;font-weight:700}
    .title-row .meta{font-size:12px;color:#979aa1}
    table{width:100%;border-collapse:collapse;border-radius:12px;border:1px solid var(--border);background:#0f1118;overflow:hidden}
    thead th{background:#171a24;color:#d6d8de;text-align:left;padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border)}
    tbody td{border-top:1px solid var(--border);padding:9px 12px;font-size:14px;color:#e9eaf0}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    tbody tr.hour-sep td{border-top:2px solid var(--accent);opacity:.35;padding:2px;font-size:11px;text-align:center;background:rgba(52,64,106,0.1)}
    .type{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;font-weight:700;margin-right:6px}
    .type.bus{background:var(--busBg);color:#a3c3ff}
    .type.rail{background:var(--railBg);color:#a3ffcc}
    tr.next{background:rgba(66,103,178,.18)}
    .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#14151b;border-radius:10px;padding:6px 10px}
    .toggle input{margin:0}
    .gear{border:1px dashed var(--border);background:#14151b;color:#cfd2d8;border-radius:8px;padding:6px 8px;cursor:pointer}
    .empty{padding:24px;text-align:center;color:#979aa1}
    footer{margin-top:28px;color:#979aa1;font-size:12px}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .modal-card{position:relative;z-index:1;width:min(520px,92vw);background:#12131a;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .modal input,.modal select{background:#14151b;border:1px solid var(--border);border-radius:8px;color:#e9e9ee;padding:6px 8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>ìº í¼ìŠ¤ ê°€ì´ë“œ | êµí†µÂ·ì‹ë‹¨</h1></header>

    <section class="card">
      <div class="toolbar">
        <button id="btnTransport" class="btn active">ğŸšŒ êµí†µ</button>
        <button id="btnMeal" class="btn">ğŸ½ï¸ ì‹ë‹¨</button>
        <span id="status" class="status">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>
      </div>

      <!-- êµí†µ ì„œë¸Œë©”ë‰´ -->
      <div id="barTransport" class="submenu open">
        <button id="btnToSchool" class="btn active">í•™êµë¡œ <span style="opacity:.7">(ë°€ì–‘â†’ë¶€ì‚°ëŒ€)</span></button>
        <button id="btnToStation" class="btn">ì—­ìœ¼ë¡œ <span style="opacity:.7">(ë¶€ì‚°ëŒ€â†’ë°€ì–‘)</span></button>

        <div class="toggle">
          <label><input id="chkBus" type="checkbox" checked /> ğŸšŒ ë²„ìŠ¤</label>
          <label><input id="chkRail" type="checkbox" /> ğŸšŠ ì² ë„</label>
          <button id="btnRailCfg" class="gear" title="ì² ë„ ì„¤ì •">âš™ï¸</button>
        </div>
      </div>

      <!-- ìš”ì¼ íƒ­(êµí†µ) -->
      <div id="tabsDay" class="tabs" style="display:flex;">
        <button class="tab active" data-day="í‰ì¼">í‰ì¼</button>
        <button class="tab" data-day="ì£¼ë§Â·ê³µíœ´ì¼">ì£¼ë§Â·ê³µíœ´ì¼</button>
        <button class="tab" data-day="ë°©í•™">ë°©í•™</button>
      </div>

      <!-- ì‹ë‹¨ ì„œë¸Œë©”ë‰´ -->
      <div id="barMeal" class="submenu">
        <button id="btnDorm" class="btn">ê¸°ìˆ™ì‚¬</button>
        <button id="btnUnion" class="btn">í•™ìƒíšŒê´€</button>
        <div class="controls">
          <label>ë‚ ì§œ <input id="mealDate" type="date" /></label>
        </div>
      </div>

      <div id="content" class="content">
        <div class="empty">ìƒë‹¨ì—ì„œ ë°©í–¥ê³¼ ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>
    </section>

    <footer>ë°ì´í„°: <code>bus_schedule.json</code>, <code>menu.json</code>, <code>KRIC API</code></footer>
  </div>

  <!-- ì² ë„ ì„¤ì • ëª¨ë‹¬ -->
  <div id="railModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="modal-card">
      <h3>ì² ë„(ë„ì‹œì² ë„) ì¡°íšŒ ì„¤ì •</h3>
      <div class="row">
        <small>â€» <code>rail_codes.json</code> ë˜ëŠ” ìš´ì˜ê¸°ê´€/ì—­ ì½”ë“œ ì—‘ì…€ì„ ë£¨íŠ¸ì— ë‘ë©´ ìë™ ë“œë¡­ë‹¤ìš´ë©ë‹ˆë‹¤.</small>
      </div>
      <div class="row">
        <label>ìš´ì˜ê¸°ê´€
          <input id="inpOpr" placeholder="ì˜ˆ: B1(ë¶€ì‚°)" />
        </label>
        <label>ì„ ì½”ë“œ
          <input id="inpLine" placeholder="ì˜ˆ: 1" />
        </label>
        <label>ì—­ì½”ë“œ
          <input id="inpStation" placeholder="ì˜ˆ: 109" />
        </label>
      </div>
      <div class="row">
        <button id="btnRailSave" class="btn">ì €ì¥</button>
        <button id="btnRailClose" class="btn ghost">ë‹«ê¸°</button>
      </div>
      <div class="row"><small id="railHint" style="color:#9cc7da"></small></div>
    </div>
  </div>

  <!-- (ì„ íƒ) XLSX íŒŒì‹±ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  // ===== App State =====
  const STATE = {
    mode: 'transport',
    direction: 'toSchool',       // 'toSchool' | 'toStation'
    dayType: 'í‰ì¼',             // í‰ì¼ | ì£¼ë§Â·ê³µíœ´ì¼ | ë°©í•™
    showBus: true,
    showRail: false,
    busLoaded: false,
    bus: { toSchool: [], toStation: [] }, // from bus_schedule.json  :contentReference[oaicite:4]{index=4}
    mealsLoaded: false,
    meals: {},                   // from menu.json (optional)        :contentReference[oaicite:5]{index=5}
    railCfg: { railOprIsttCd:'', lnCd:'', stinCd:'' }, // user config
    railCache: { }               // key(dayType+direction) -> rows
  };

  // ===== Utilities =====
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function showStatus(msg){ const s=$("#status"); if(!s) return; if(msg){s.textContent=msg; s.style.display='inline-flex'} else {s.style.display='none'} }
  const pad = n=>String(n).padStart(2,'0');
  function fmtTime(v){
    if(!v) return "";
    let s=String(v).trim();
    let m = s.match(/^(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/);
    if(m){ let h=+m[2], mi=pad(m[3]); const pm=m[1]==='ì˜¤í›„'; if(pm && h!==12) h+=12; if(!pm && h===12) h=0; return pad(h)+':'+mi; }
    m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/); if(m) return pad(m[1])+':'+m[2];
    return s;
  }
  const toMinutes = hhmm => { const s = fmtTime(hhmm); const m=s.match(/^(\d{2}):(\d{2})$/); return m ? (+m[1]*60 + +m[2]) : NaN; };
  const nowMinutes = () => new Date().getHours()*60 + new Date().getMinutes();

  // ===== Data Loaders =====
  async function ensureBusLoaded(){
    if(STATE.busLoaded) return;
    showStatus('ë²„ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    const r = await fetch('./bus_schedule.json',{cache:'no-store'}); // :contentReference[oaicite:6]{index=6}
    if(!r.ok) { showStatus(''); alert('bus_schedule.json ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return; }
    STATE.bus = await r.json();
    STATE.busLoaded = true;
    showStatus('');
  }

  async function ensureMealsLoaded(){
    if(STATE.mealsLoaded) return;
    showStatus('ì‹ë‹¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    const r = await fetch('./menu.json',{cache:'no-store'});        // :contentReference[oaicite:7]{index=7}
    if(!r.ok){ showStatus(''); return; }
    STATE.meals = await r.json();
    STATE.mealsLoaded = true;
    showStatus('');
  }

  function dayToKRIC(dayType){
    // KRIC: 7=í† , 8=í‰ì¼, 9=íœ´ì¼. ìš°ë¦¬ 'ì£¼ë§Â·ê³µíœ´ì¼'ì€ 7,9 ë‘˜ ë‹¤ í•©ì¹˜ê¸°.
    if(dayType==='í‰ì¼') return ['8'];
    if(dayType==='ì£¼ë§Â·ê³µíœ´ì¼') return ['7','9'];
    // 'ë°©í•™'ì€ ë²„ìŠ¤ë§Œ ì¡´ì¬ â†’ ì² ë„ëŠ” í‰ì¼ë¡œ ê·¼ì‚¬
    return ['8'];
  }

  async function loadRailwayOnce(direction, dayType){
    const key = direction+'|'+dayType;
    if(STATE.railCache[key]) return STATE.railCache[key];

    const days = dayToKRIC(dayType);
    const cfg = STATE.railCfg;
    if(!cfg.railOprIsttCd || !cfg.lnCd || !cfg.stinCd) return [];

    showStatus('ì² ë„ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    let rows = [];
    for(const d of days){
      const u = new URL('/api/subwayTimetable', location.origin);
      u.searchParams.set('railOprIsttCd', cfg.railOprIsttCd);
      u.searchParams.set('lnCd', cfg.lnCd);
      u.searchParams.set('stinCd', cfg.stinCd);
      u.searchParams.set('dayCd', d);
      u.searchParams.set('format','json');

      const r = await fetch(u, {cache:'no-store'});
      if(!r.ok) continue;
      const j = await r.json();
      const items = j?.response?.body?.items?.item ?? j?.items ?? [];
      for(const it of items){
        const hhmm = fmtTime(it.dptTm || it.arvTm || '');
        const min  = toMinutes(hhmm);
        if(isNaN(min)) continue;
        rows.push({
          type: 'rail',
          time: hhmm,
          timeMin: min,
          trnNo: it.trnNo || '',
          dayNm: it.dayNm || '',
          // ê°„ë‹¨í•œ í‘œì‹œì— í•„ìš”í•œ ìµœì†Œ í•„ë“œ
          station: 'ì—­ì½”ë“œ '+(it.stinCd || cfg.stinCd),
          dest: '-',  // (í•„ìš”ì‹œ í™•ì¥)
        });
      }
    }
    rows.sort((a,b)=>a.timeMin-b.timeMin);
    STATE.railCache[key] = rows;
    showStatus('');
    return rows;
  }

  // ===== Renderer: Combined Transport =====
  async function renderTransport(){
    await ensureBusLoaded();

    const content = $('#content'); content.innerHTML='';
    const title = document.createElement('div'); title.className='title-row';
    const h2 = document.createElement('h2');
    const icons = [STATE.showBus?'ğŸšŒ':null, STATE.showRail?'ğŸšŠ':null].filter(Boolean).join(' ');
    h2.innerHTML = `${icons} ${STATE.direction==='toSchool'?'ë°€ì–‘ â†’ ë¶€ì‚°ëŒ€':'ë¶€ì‚°ëŒ€ â†’ ë°€ì–‘'}`;
    const meta = document.createElement('span'); meta.className='meta'; meta.textContent = STATE.dayType;
    title.appendChild(h2); title.appendChild(meta); content.appendChild(title);

    // 1) ë²„ìŠ¤ rows
    const busRowsRaw = (STATE.bus[STATE.direction]||[]).filter(d=>d.day_type===STATE.dayType); // :contentReference[oaicite:8]{index=8}
    const busRows = STATE.showBus ? busRowsRaw.map(r=>{
      const timeField = STATE.direction==='toSchool' ? (r.t['ë°€ì–‘ì—­'] || r.t['ì‹œê°„']) : (r.t['ë¶€ì‚°ëŒ€'] || r.t['ì‹œê°„']);
      const timeMin = toMinutes(timeField);
      return isNaN(timeMin) ? null : {
        type:'bus',
        time: fmtTime(timeField),
        timeMin,
        run: r.run,
        t: r.t
      };
    }).filter(Boolean) : [];

    // 2) ì² ë„ rows
    const railRows = STATE.showRail ? await loadRailwayOnce(STATE.direction, STATE.dayType) : [];

    // 3) í•©ì¹˜ê³  ì •ë ¬
    const rows = [...busRows, ...railRows].sort((a,b)=>a.timeMin-b.timeMin);
    if(rows.length===0){
      const empty = document.createElement('div'); empty.className='empty'; empty.textContent='í•´ë‹¹ ì¡°ê±´ì˜ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.';
      content.appendChild(empty); return;
    }

    // 4) í‘œ ê·¸ë¦¬ê¸°
    const table = document.createElement('table');
    const thead = document.createElement('thead'); const trh=document.createElement('tr');
    const cols = STATE.direction==='toSchool' ? ['êµ¬ë¶„','ì¶œë°œ','ì˜ë‚¨ë£¨','ë°€ì–‘ì—­','ë¶€ì‚°ëŒ€'] : ['êµ¬ë¶„','ì¶œë°œ','ë¶€ì‚°ëŒ€','ë°€ì–‘ì—­','ì˜ë‚¨ë£¨'];
    cols.forEach(c=>{const th=document.createElement('th'); th.textContent=c; trh.appendChild(th);});
    thead.appendChild(trh); table.appendChild(thead);
    const tbody = document.createElement('tbody');

    const nowMin = nowMinutes(); let nextMarked=false; let lastHour=-1;

    for(const item of rows){
      // ì‹œê° êµ¬ë¶„ì„ 
      const hour = Math.floor(item.timeMin/60);
      if(hour!==lastHour){
        const sep=document.createElement('tr'); sep.className='hour-sep';
        const td=document.createElement('td'); td.colSpan=cols.length; td.textContent=`â”â”â” ${hour}ì‹œ â”â”â”`;
        sep.appendChild(td); tbody.appendChild(sep); lastHour=hour;
      }

      const tr = document.createElement('tr');
      if(!nextMarked && item.timeMin>=nowMin){ tr.classList.add('next'); nextMarked=true; }

      if(item.type==='bus'){
        const badge = `<span class="type bus">ë²„ìŠ¤</span>`;
        if(STATE.direction==='toSchool'){
          tr.innerHTML = `
            <td>${badge}${item.run?`${item.run}íšŒ`:''}</td>
            <td>${fmtTime(item.t['ì‹œê°„']||'')}</td>
            <td>${fmtTime(item.t['ì˜ë‚¨ë£¨']||'')}</td>
            <td>${fmtTime(item.t['ë°€ì–‘ì—­']||'')}</td>
            <td>${fmtTime(item.t['ë¶€ì‚°ëŒ€']||'')}</td>`;
        }else{
          tr.innerHTML = `
            <td>${badge}${item.run?`${item.run}íšŒ`:''}</td>
            <td>${fmtTime(item.t['ì‹œê°„']||item.t['ë¶€ì‚°ëŒ€']||'')}</td>
            <td>${fmtTime(item.t['ë¶€ì‚°ëŒ€']||'')}</td>
            <td>${fmtTime(item.t['ë°€ì–‘ì—­']||'')}</td>
            <td>${fmtTime(item.t['ì˜ë‚¨ë£¨']||'')}</td>`;
        }
      }else{ // rail
        const badge = `<span class="type rail">ì² ë„</span>`;
        if(STATE.direction==='toSchool'){
          tr.innerHTML = `
            <td>${badge}${item.trnNo||''}</td>
            <td>${item.time}</td>
            <td>-</td>
            <td>${item.station}</td>
            <td>${item.dest}</td>`;
        }else{
          tr.innerHTML = `
            <td>${badge}${item.trnNo||''}</td>
            <td>${item.time}</td>
            <td>${item.dest}</td>
            <td>${item.station}</td>
            <td>-</td>`;
        }
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    content.appendChild(table);
  }

  // ===== Meals (optional) =====
  async function renderMeals(hall){
    await ensureMealsLoaded();
    const content = $('#content'); content.innerHTML='';
    const date = $('#mealDate').value || new Date().toISOString().slice(0,10);
    const data = STATE.meals[hall]?.[date];
    const title = document.createElement('div'); title.className='title-row';
    title.innerHTML = `<h2>ğŸ½ï¸ ${hall}</h2><span class="meta">${date}</span>`;
    content.appendChild(title);
    if(!data){ content.appendChild(Object.assign(document.createElement('div'),{className:'empty',textContent:'ë°ì´í„° ì—†ìŒ'})); return; }
    const sections = ['ì•„ì¹¨','ì ì‹¬','ì €ë…'];
    sections.forEach(sec=>{
      const card = document.createElement('div'); card.className='content';
      const h = document.createElement('h3'); h.textContent=sec; content.appendChild(h);
      const ul=document.createElement('ul'); (data[sec]||[]).forEach(x=>{const li=document.createElement('li'); li.textContent=x; ul.appendChild(li);}); content.appendChild(ul);
    });
  }

  // ===== Rail Settings (modal + auto-source) =====
  async function tryLoadRailCodes(){
    const hint = $('#railHint');
    // 1) rail_codes.json
    try{
      const r = await fetch('./rail_codes.json',{cache:'no-store'});
      if(r.ok){
        hint.textContent = 'rail_codes.jsonì—ì„œ ì½”ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
        return; // (ê°„ë‹¨ ëª¨ë‹¬ì´ë¼ ì…€ë ‰íŠ¸ëŠ” ìƒëµ, í•„ìš”ì‹œ í™•ì¥)
      }
    }catch{}
    // 2) ì—‘ì…€ ìë™ íŒŒì‹±(íŒŒì¼ëª…ì€ ì˜ˆì‹œ)
    try{
      const rx = await fetch('./ìš´ì˜ê¸°ê´€_ì—­ì‚¬_ì½”ë“œì •ë³´_2025.07.04.xls');
      if(rx.ok){
        const buf = await rx.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(buf),{type:'array'});
        if(wb.SheetNames?.length){ hint.textContent = 'ì—‘ì…€ì—ì„œ ì½”ë“œ ì •ë³´ë¥¼ ìë™ ì¸ì‹í–ˆìŠµë‹ˆë‹¤.'; return; }
      }
    }catch{}
    hint.textContent = 'ì½”ë“œëŠ” ìˆ˜ë™ ì…ë ¥í•˜ì„¸ìš”.';
  }

  // ===== Wire UI =====
  function setActive(el, groupSel){
    $$(groupSel).forEach(b=>b.classList.remove('active')); el.classList.add('active');
  }

  function init(){
    // Top buttons
    $('#btnTransport').addEventListener('click', ()=>{
      STATE.mode='transport';
      $('#btnTransport').classList.add('active'); $('#btnMeal').classList.remove('active');
      $('#barTransport').classList.add('open'); $('#tabsDay').style.display='flex';
      $('#barMeal').classList.remove('open');
      renderTransport();
    });
    $('#btnMeal').addEventListener('click', ()=>{
      STATE.mode='meal';
      $('#btnMeal').classList.add('active'); $('#btnTransport').classList.remove('active');
      $('#barTransport').classList.remove('open'); $('#tabsDay').style.display='none';
      $('#barMeal').classList.add('open');
      $('#mealDate').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
      renderMeals('ê¸°ìˆ™ì‚¬');
    });

    // Direction
    $('#btnToSchool').addEventListener('click', (e)=>{ STATE.direction='toSchool'; setActive(e.currentTarget,'.submenu .btn'); renderTransport(); });
    $('#btnToStation').addEventListener('click', (e)=>{ STATE.direction='toStation'; setActive(e.currentTarget,'.submenu .btn'); renderTransport(); });

    // Day tabs
    $$('#tabsDay .tab').forEach(b=>{
      b.addEventListener('click', (e)=>{
        setActive(e.currentTarget,'#tabsDay .tab'); STATE.dayType = e.currentTarget.dataset.day; renderTransport();
      });
    });

    // Toggles
    $('#chkBus').addEventListener('change', (e)=>{ STATE.showBus = e.target.checked; renderTransport(); });
    $('#chkRail').addEventListener('change', async (e)=>{
      STATE.showRail = e.target.checked;
      if(STATE.showRail && (!STATE.railCfg.railOprIsttCd || !STATE.railCfg.lnCd || !STATE.railCfg.stinCd)){
        openRailModal(); return;
      }
      renderTransport();
    });

    // Rail modal
    $('#btnRailCfg').addEventListener('click', openRailModal);
    $('.backdrop').addEventListener('click', closeRailModal);
    $('#btnRailClose').addEventListener('click', closeRailModal);
    $('#btnRailSave').addEventListener('click', ()=>{
      STATE.railCfg.railOprIsttCd = $('#inpOpr').value.trim();
      STATE.railCfg.lnCd = $('#inpLine').value.trim();
      STATE.railCfg.stinCd = $('#inpStation').value.trim();
      STATE.railCache = {}; // reset cache
      closeRailModal(); renderTransport();
    });

    // defaults
    renderTransport();
  }

  function openRailModal(){
    $('#inpOpr').value = STATE.railCfg.railOprIsttCd || '';
    $('#inpLine').value = STATE.railCfg.lnCd || '';
    $('#inpStation').value = STATE.railCfg.stinCd || '';
    $('#railModal').classList.add('open');
    tryLoadRailCodes();
  }
  function closeRailModal(){ $('#railModal').classList.remove('open'); }

  // start
  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
